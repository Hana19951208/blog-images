name: Parallel Image Pipeline

on:
  push:
    paths:
      - '**.jpg'
      - '**.jpeg'
      - '**.png'
      - '**.webp'
  workflow_dispatch:

# 确保并发上传时排队执行，防止 Git 提交冲突
concurrency:
  group: image-hosting
  cancel-in-progress: false

jobs:
  # 1. 甄别发现 Job：负责筛选变动图片
  filter:
    runs-on: ubuntu-latest
    outputs:
      has_images: ${{ steps.check.outputs.has_images }}
      IMAGES_LIST: ${{ steps.check.outputs.IMAGES_LIST }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - id: check
        run: |
          IMAGES=$(git diff --name-only --diff-filter=AM HEAD^ HEAD | grep -E "\.(jpg|jpeg|png|webp)$" | xargs echo || true)
          if [ -z "$IMAGES" ]; then
            echo "has_images=false" >> $GITHUB_OUTPUT
          else
            echo "has_images=true" >> $GITHUB_OUTPUT
            echo "IMAGES_LIST=$IMAGES" >> $GITHUB_OUTPUT
            echo ">>> [Found] $IMAGES"
          fi

  # 2. 快路径 (Fast Path)：CDN 预热，独立运行，最快开始
  preheat:
    needs: filter
    if: needs.filter.outputs.has_images == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: CDN Preheat
        env:
          CDN_DOMAIN: ${{ secrets.CDN_DOMAIN || 'img.fangenwu.cn' }}
          FILES: ${{ needs.filter.outputs.IMAGES_LIST }}
        run: |
          echo ">>> [Fast Path] 启动针对源文件的 CDN 预热..."
          # 这里不需要等待，因为图片推送到 GitHub 后 Raw 立即生效
          for FILE in $FILES; do
            URL="https://$CDN_DOMAIN/$FILE"
            STATUS=$(curl -s -L -o /dev/null -I -w "%{http_code}" "$URL")
            echo ">>> [Warmup] $STATUS - $URL"
          done

  # 3. 后台路径 (Background Path)：压缩、提交、微信同步
  background-sync:
    needs: filter
    if: needs.filter.outputs.has_images == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Step 3.1 - 增量压缩
        run: |
          sudo apt-get update && sudo apt-get install -y jpegoptim optipng webp
          for FILE in ${{ needs.filter.outputs.IMAGES_LIST }}; do
            echo ">>> [Compressing] $FILE"
            if [[ $FILE == *.jpg ]] || [[ $FILE == *.jpeg ]]; then
              jpegoptim --size=400k "$FILE"
            elif [[ $FILE == *.png ]]; then
              optipng -o2 "$FILE"
            fi
          done

      - name: Step 3.2 - 自动回传仓库
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: 自动化优化图片资产 [skip ci]"
          branch: main

      - name: Step 3.3 - 同步至微信公众号 (中转服务器执行)
        uses: appleboy/ssh-action@v1.2.0
        env:
          WECHAT_APP_ID: ${{ secrets.WECHAT_APP_ID }}
          WECHAT_APP_SECRET: ${{ secrets.WECHAT_APP_SECRET }}
          IMAGES_LIST: ${{ needs.filter.outputs.IMAGES_LIST }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          envs: WECHAT_APP_ID,WECHAT_APP_SECRET,IMAGES_LIST,GITHUB_REPOSITORY
          script: |
            cd ~/blog-sync
            
            # 更新脚本
            curl -s -L -o sync_to_wechat.py "https://raw.githubusercontent.com/$GITHUB_REPOSITORY/main/scripts/sync_to_wechat.py"
            
            # 安装依赖并执行
            echo ">>> [WeChat] 启动后台同步逻辑..."
            python3 sync_to_wechat.py "$IMAGES_LIST"